name: Autonomous Agents

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

env:
  ENABLE_SEPOLIA_DEPLOY: ${{ secrets.ENABLE_SEPOLIA_DEPLOY }}
  SEPOLIA_RPC_URL: ${{ secrets.SEPOLIA_RPC_URL }}
  DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
  ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
  INFURA_API_KEY: ${{ secrets.INFURA_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
  THIRDWEB_SECRET_KEY: ${{ secrets.THIRDWEB_SECRET_KEY }}

jobs:
  secrets_check:
    name: Secrets Check
    runs-on: ubuntu-latest
    steps:
      - name: Print secrets status
        run: |
          echo "ENABLE_SEPOLIA_DEPLOY=${{ env.ENABLE_SEPOLIA_DEPLOY }}"
          echo "SEPOLIA_RPC_URL=${{ env.SEPOLIA_RPC_URL != '' }}"
          echo "DEPLOYER_PRIVATE_KEY=${{ env.DEPLOYER_PRIVATE_KEY != '' }}"
          echo "ETHERSCAN_API_KEY=${{ env.ETHERSCAN_API_KEY != '' }}"
          echo "INFURA_API_KEY=${{ env.INFURA_API_KEY != '' }}"
          echo "SUPABASE_URL=${{ env.SUPABASE_URL != '' }}"
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ env.SUPABASE_SERVICE_ROLE_KEY != '' }}"
          echo "THIRDWEB_SECRET_KEY=${{ env.THIRDWEB_SECRET_KEY != '' }}"

  contracts_agent:
    name: Contracts Agent
    runs-on: ubuntu-latest
    needs: [secrets_check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Install dependencies (contracts)
        run: npm ci
        working-directory: contracts
      - name: Compile contracts
        run: npx hardhat compile
        working-directory: contracts
      - name: Verify setup
        run: node verify-setup.js
        working-directory: contracts
      - name: Blockchain connectivity test
        run: node scripts/test-blockchain.js
        env:
          INFURA_API_KEY: ${{ env.INFURA_API_KEY }}

  backend_agent:
    name: Backend Agent
    runs-on: ubuntu-latest
    needs: [secrets_check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Install dependencies (backend)
        run: npm ci
        working-directory: packages/backend
      - name: Build backend
        run: npm run build --if-present
        working-directory: packages/backend

  monitoring_agent:
    name: Monitoring Agent
    runs-on: ubuntu-latest
    needs: [secrets_check]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Supabase connectivity test
        run: node scripts/test-supabase-setup.js
        env:
          SUPABASE_URL: ${{ env.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ env.SUPABASE_SERVICE_ROLE_KEY }}
      - name: Telegram test (optional)
        run: node scripts/test-telegram.js || true

  sepolia_deploy:
    name: Sepolia Auto-Deploy
    runs-on: ubuntu-latest
    needs: [contracts_agent]
    if: ${{ env.ENABLE_SEPOLIA_DEPLOY == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      - name: Install dependencies (contracts)
        run: npm ci
        working-directory: contracts
      - name: Deploy to Sepolia
        run: node scripts/deploy-sepolia.js
        working-directory: contracts
        env:
          PRIVATE_KEY: ${{ env.DEPLOYER_PRIVATE_KEY }}
          SEPOLIA_RPC_URL: ${{ env.SEPOLIA_RPC_URL }}
          ETHERSCAN_API_KEY: ${{ env.ETHERSCAN_API_KEY }}
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: sepolia-deployment
          path: contracts/deployment-sepolia.json
