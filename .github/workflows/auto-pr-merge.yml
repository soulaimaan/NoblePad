name: Auto PR and Merge

on:
  workflow_dispatch:

jobs:
  create_and_merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure branch exists
        uses: actions/github-script@v7
        with:
          script: |
            const branch = 'clean-agents-setup';
            try {
              await github.repos.getBranch({ owner: context.repo.owner, repo: context.repo.repo, branch });
            } catch (e) {
              core.setFailed(`Branch ${branch} not found`);
            }

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: clean-agents-setup
          title: "Bootstrap CI and Autonomous Agents; ignore build artifacts"
          body: |
            This PR sets up:
            - CI pipeline for frontend, backend, and contracts
            - Autonomous agents for contracts/backend/monitoring and Sepolia auto-deploy (gated by secrets)
            - Vercel deploy workflow
            - Next.js ESM config fix
            It also ignores build artifacts and node_modules to avoid large-file pushes.

      - name: Merge Pull Request
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: actions/github-script@v7
        with:
          script: |
            const pr = Number(core.getInput('pr', { required: false })) || Number('${{ steps.cpr.outputs.pull-request-number }}');
            await github.pulls.merge({ owner: context.repo.owner, repo: context.repo.repo, pull_number: pr, merge_method: 'squash' });
