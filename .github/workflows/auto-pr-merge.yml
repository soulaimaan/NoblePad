name: Auto PR and Merge

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create_and_merge:
    runs-on: ubuntu-latest
    steps:
      - name: Create and merge PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = 'clean-agents-setup';
            const base = 'main';
            let pr;
            try {
              pr = await github.pulls.create({ owner, repo, head, base, title: 'Bootstrap CI and Autonomous Agents; ignore build artifacts' });
            } catch (e) {
              if (e.status === 422) {
                const { data: prs } = await github.pulls.list({ owner, repo, state: 'open', head: `${owner}:${head}`, base });
                if (!prs.length) throw e;
                pr = { data: prs[0] };
              } else {
                throw e;
              }
            }
            await github.pulls.merge({ owner, repo, pull_number: pr.data.number, merge_method: 'squash' });
